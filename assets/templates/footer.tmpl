{{define "public/footer"}}
<script>
    function uploadFile(file) {
        var limit = 10 * 1024 * 1024;
        if (file.size <= limit) {
            uploadImg(file, 1, file.name).then((url) => {
                // 处理上传成功的情况
                console.log(url);
            }).catch((error) => {
                // 处理上传失败的情况
                console.error(error);
            });
        } else {
            // 文件大于20MB，需要分割成多个块
            var chunkSize = limit; // 20MB
            var start = 0;
            var end = Math.min(chunkSize, file.size);
            function uploadNextChunk() {
                if (start < file.size) {
                    var chunk = file.slice(start, end);
                    return uploadImg(chunk, 0, file.name)
                        .then((url) => {
                            // 处理上传成功的情况
                            temp = temp + '\n' + url.replace(/^\/d\//, ''); // 每次改变值都换行
                            start = end;
                            end = Math.min(start + chunkSize, file.size);
                            return uploadNextChunk(); // 上传下一个块
                        })
                        .catch((error) => {
                            // 处理上传失败的情况
                            console.error(error);
                            var t = $('<div class="response-item response-error">上传失败(' + e.message + ')</div>');
                            $("#response").prepend(t);
                            return Promise.reject("Upload failed"); // 终止上传
                        });
                } else {
                    return Promise.resolve(); // 如果所有块都上传完成，返回一个已解决的 Promise
                }

            }
            var temp = "tgstate-blob";
            temp = temp + '\n' + file.name;
            temp = temp + '\nsize' + file.size;
            uploadNextChunk()
                .then(() => {
                    console.log(temp); // 所有块上传完成后打印
                    // 将字符串转换为 Blob 对象
                    var blob = new Blob([temp], { type: 'text/plain' });
                    var fileAll = new File([blob], 'fileAll.txt', { type: 'text/plain' });
                    return uploadImg(fileAll, 1, file.name);
                })
                .catch((error) => {
                    // 处理上传失败的情况
                    console.error(error);
                });
        }
    }
    function uploadImg(e, ms, fileName) {
        return new Promise((resolve, reject) => {
            var o = new FormData();
            o.append("file", e);
            var isImage = e.type.startsWith('image/');
            var displayFileName = fileName || e.name || 'Unknown file';
            $("#uploadButton").prop("disabled", !0);
            $("#uploadButton").text("Uploading");
            $("#loading").show();
            var a = window.location.protocol + "//" + window.location.hostname;
            "80" !== window.location.port &&
                0 < window.location.port.length &&
                (a = a + ":" + window.location.port),
                $.ajax({
                    type: "POST",
                    url: window.location.href.replace(/\/$/, "") + "/api",
                    data: o,
                    contentType: !1,
                    processData: !1,
                    success: function (e) {

                        var link = window.location.href.replace(/\/$/, "") + e.message;
                        var proxyUrl = e.proxyUrl
                        var t;
                        if (e.code == 1) {
                            if (ms) {
                                var shortLink = e.shortFileUrl ? window.location.href.replace(/\/$/, "") + e.shortUrl : '';
                                var fileNameToShow = displayFileName;
                                
                                if (isImage) {
                                    var shortLinkHtml = shortLink ? 
                                        '<div class="response-item response-success">' +
                                        '<div class="file-info">✅ <strong>' + fileNameToShow + '</strong></div>' +
                                        '<div class="file-link"><a target="_blank" href="' + shortLink + '">' + shortLink + '</a></div>' +
                                        '<div class="copy-links">' +
                                        '<span class="copy-code" data-clipboard-text="' + shortLink + '">Copy Link</span>' +
                                        '<span class="copy-code" data-clipboard-text="&lt;img src=&quot;' + shortLink + '&quot; alt=&quot;' + fileNameToShow + '&quot;&gt;">HTML</span>' +
                                        '<span class="copy-code" data-clipboard-text="![' + fileNameToShow + '](' + shortLink + ')">Markdown</span>' +
                                        '</div></div>' : '';
                                    
                                    t = $(shortLinkHtml);
                                } else {
                                    var shortLinkHtml = shortLink ? 
                                        '<div class="response-item response-success">' +
                                        '<div class="file-info">✅ <strong>' + fileNameToShow + '</strong></div>' +
                                        '<div class="file-link"><a target="_blank" href="' + shortLink + '">' + shortLink + '</a></div>' +
                                        '<div class="copy-links">' +
                                        '<span class="copy-code" data-clipboard-text="' + shortLink + '">Copy Link</span>' +
                                        '</div></div>' : '';
                                    
                                    t = $(shortLinkHtml);
                                }
                            }
                            resolve(e.message);
                        } else {
                            var t = $('<div class="response-item response-error">Upload failed (' + e.message + ')</div>');
                            reject("Upload failed (" + e.message + ")");
                        }
                        $("#response").prepend(t);
                        $("#uploadFile").val("");
                        $("#uploadFileLabel")
                            .text("Choose Files")
                            .css("background-color", "#007BFF");
                        
                        // 重置上传按钮状态
                        $("#uploadButton").prop("disabled", true);
                        $("#uploadButton").text("⬆️ Please select files first");

                        $(".copy-code").click(function () {
                            var code = $(this).data("clipboard-text");
                            var copyButton = $(this);
                            var originalText = copyButton.text();
                            
                            // 使用现代的 Clipboard API，如果不支持则回退到旧方法
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(code).then(function() {
                                    copyButton.text("Copied!").addClass("copied");
                                    setTimeout(function () {
                                        copyButton.text(originalText).removeClass("copied");
                                    }, 1500);
                                }).catch(function() {
                                    // 如果 Clipboard API 失败，使用旧方法
                                    fallbackCopy(code, copyButton, originalText);
                                });
                            } else {
                                // 使用旧的复制方法
                                fallbackCopy(code, copyButton, originalText);
                            }
                        });
                        
                        function fallbackCopy(text, button, originalText) {
                            var input = $("<input>");
                            $("body").append(input);
                            input.val(text).select();
                            try {
                                document.execCommand("copy");
                                button.text("Copied!").addClass("copied");
                                setTimeout(function () {
                                    button.text(originalText).removeClass("copied");
                                }, 1500);
                            } catch (err) {
                                button.text("Copy failed");
                                setTimeout(function () {
                                    button.text(originalText);
                                }, 1500);
                            }
                            input.remove();
                        }
                        return e.message;
                    },
                    error: function () {
                        var errorResponse = $('<div class="response-item response-error">Upload failed</div>');
                        $("#response").prepend(errorResponse);
                        reject("Upload failed");
                    },
                    complete: function () {
                        // 检查是否还有文件选中
                        var input = document.getElementById("uploadFile");
                        if (input.files.length > 0) {
                            $("#uploadButton").prop("disabled", false);
                            $("#uploadButton").text("⬆️ Start Upload");
                        } else {
                            $("#uploadButton").prop("disabled", true);
                            $("#uploadButton").text("⬆️ Please select files first");
                        }
                        $("#loading").hide();
                    }
                });
        });
    }
    function readAndUploadFile(file) {
        // 直接调用上传文件的函数
        uploadFile(file);
    }
    document.addEventListener("paste", function (e) {
        for (var o = e.clipboardData.items, t = 0; t < o.length; t++) {
            var a,
                n = o[t];
            -1 !== n.type.indexOf("image") &&
                ((a = n.getAsFile()),
                    $("#uploadFileLabel")
                        .text("Clipboard file selected")
                        .css("background-color", "#0056b3"),
                    // 启用上传按钮
                    $("#uploadButton").prop("disabled", false),
                    $("#uploadButton").text("⬆️ Start Upload"),
                    uploadFile(a));
        }
    }),
        $(document).ready(function () {
            $("#uploadFile").change(function () {
                var files = $(this)[0].files;
                if (files.length > 0) {
                    if (files.length === 1) {
                        $("#uploadFileLabel")
                            .text("Selected: " + files[0].name)
                            .css("background-color", "#0056b3");
                    } else {
                        $("#uploadFileLabel")
                            .text("Selected " + files.length + " files")
                            .css("background-color", "#0056b3");
                    }
                } else {
                    $("#uploadFileLabel")
                        .text("Choose Files")
                        .css("background-color", "#007BFF");
                }
            });
            // 上传按钮点击事件已在files.tmpl中处理，这里不再重复绑定
        });
</script>

</body>

</html>
{{end}}